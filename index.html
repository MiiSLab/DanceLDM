<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta
			name="description"
			content="DanceLDM: Latent-based diffusion model for dance generation and editing conditioned on music and text prompt."
		/>
		<meta name="keywords" content="DanceLDM, diffusion" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>DanceLDM: Latent-based diffusion model for dance generation and editing conditioned on music and text prompt</title>

		<!-- Global site tag (gtag.js) - Google Analytics -->
		<!-- <script async src="https://www.googletagmanager.com/gtag/js?id=G-PYVRSFMDRL"></script> -->
		<!-- <script>
			window.dataLayer = window.dataLayer || [];

			function gtag() {
				dataLayer.push(arguments);
			}

			gtag('js', new Date());

			gtag('config', 'G-PYVRSFMDRL');
		</script> -->

		<link href="https://fonts.googleapis.com/css?family=Google+Sans|Noto+Sans|Castoro" rel="stylesheet" />

		<link rel="stylesheet" href="./static/css/bulma.min.css" />
		<link rel="stylesheet" href="./static/css/bulma-carousel.min.css" />
		<link rel="stylesheet" href="./static/css/bulma-slider.min.css" />
		<link rel="stylesheet" href="./static/css/fontawesome.all.min.css" />
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css" />
		<link rel="stylesheet" href="./static/css/index.css" />
		<!-- <link rel="stylesheet" href="./static/css/test.css" /> -->
		<link rel="icon" href="./static/images/logo.png" />

		<!-- tailwindcss -->
		<script src="https://cdn.tailwindcss.com"></script>
		<script>
			tailwind.config = {
				theme: {
					extend: {
						colors: {
							bg: '#314c78',
							btn: '#6262AE',
							nav: '#1C2229',
							'video-container': '#2D3F54',
							video: '#495363',
							container: '#29313D',
						},
					},
				},
			};
		</script>
		<script
			src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"
			integrity="sha512-11t8Q+vY9JlCrr+PveZKTYJq8n7O09Y5X/pk/aMd3vJugSvu4xOunGEUzaADqL3I8cZKE/pBwwCfXzDkRJh2sQ=="
			crossorigin="anonymous"
			referrerpolicy="no-referrer"
		></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
		<script defer src="./static/js/fontawesome.all.min.js"></script>
		<script src="./static/js/bulma-carousel.min.js"></script>
		<script src="./static/js/bulma-slider.min.js"></script>
		<script src="./static/js/index.js"></script>
		<style>
			@keyframes ellipsis {
				0% {
					content: '';
				}
				33% {
					content: '.';
				}
				66% {
					content: '..';
				}
				100% {
					content: '...';
				}
			}
			.after\:animate-ellipsis::after {
				animation: ellipsis 1s steps(4, end) infinite;
			}
		</style>
	</head>
	<body>
		<!-- <span id="avatarProgressLabel" class="text-lg font-bold text-blue-500">Generating... <span id="progressText">1%</span></span>
		<p>Generating<span class="animate-pulse after:content-['.'] after:animate-ellipsis"></span>1%</p>
		<span id="avatarProgressLabel" class="text-lg font-bold text-blue-500">
			Generating<span class="animate-pulse after:content-['.'] after:animate-ellipsis"></span>
			<span id="progressText">1%</span>
		</span> -->
		<nav class="navbar" role="navigation" aria-label="main navigation">
			<div class="navbar-brand">
				<a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
					<span aria-hidden="true"></span>
					<span aria-hidden="true"></span>
					<span aria-hidden="true"></span>
				</a>
			</div>
		</nav>

		<section class="hero">
			<div class="hero-body">
				<div class="container is-max-desktop">
					<div class="columns is-centered">
						<div class="column has-text-centered">
							<h1 class="title is-1 publication-title">
								DanceLDM: Latent-based diffusion model for dance generation and editing conditioned on music and text prompt
							</h1>
							<div class="is-size-5 publication-authors">
								<span class="author-block">
									<a href="https://sites.google.com/view/ntust-miislab">Ming-Cong Su</a><sup>1</sup></span
								>
								<!-- <span class="author-block">
									<a href="https://sites.google.com/view/ntust-miislab">Tse-Yu Pan</a><sup>2</sup>,</span
								> -->

								<div class="is-size-5 publication-authors">
									<!-- <span class="author-block"><sup>1</sup>National Taiwan University of Science and Technology,</span> -->
									<!-- <span class="author-block"><sup>2</sup>MiiSLab</span> -->
								</div>

								<div class="column has-text-centered">
									<!-- <div class="publication-links">
										<span class="link-block">
											<a
												href="https://sites.google.com/view/ntust-miislab"
												class="external-link button is-normal is-rounded is-dark"
											>
												<span class="icon">
													<i class="fas fa-file-pdf"></i>
												</span>
												<span>Paper</span>
											</a>
										</span>
										<span class="link-block">
											<a
												href="https://sites.google.com/view/ntust-miislab"
												class="external-link button is-normal is-rounded is-dark"
											>
												<span class="icon">
													<i class="ai ai-arxiv"></i>
												</span>
												<span>arXiv</span>
											</a>
										</span>
										<span class="link-block">
											<a
												href="https://sites.google.com/view/ntust-miislab"
												class="external-link button is-normal is-rounded is-dark"
											>
												<span class="icon">
													<i class="fab fa-youtube"></i>
												</span>
												<span>Video</span>
											</a>
										</span>
										<span class="link-block">
											<a
												href="https://sites.google.com/view/ntust-miislab"
												class="external-link button is-normal is-rounded is-dark"
											>
												<span class="icon">
													<i class="fab fa-github"></i>
												</span>
												<span>Code</span>
											</a>
										</span>
									</div> -->
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>

		<section class="section">
			<div class="columns is-centered has-text-centered">
				<div class="column is-four-fifths">
					<div class="publication-video">
						<img src="./static/images/danceldm.png" alt="Teaser Image" style="width: 80%" />
					</div>
				</div>
			</div>
		</section>

		<section class="hero is-light is-small">
			<div class="hero-body">
				<div class="container">
					<div id="results-carousel" class="carousel results-carousel">
						<div class="item item-steve" autoplay controls muted loop playsinline height="100%">
							<video poster="" id="t1">
								<source src="./static/videos/test_video1.mp4" type="video/mp4" />
							</video>
						</div>
						<div class="item item-chair-tp">
							<video poster="" id="t2" autoplay controls muted loop playsinline height="100%">
								<source src="./static/videos/test_video2.mp4" type="video/mp4" />
							</video>
						</div>
						<div class="item item-shiba">
							<video poster="" id="t3" autoplay controls muted loop playsinline height="100%">
								<source src="./static/videos/test_video3.mp4" type="video/mp4" />
							</video>
						</div>
						<div class="item item-chair-tp">
							<video poster="" id="t4" autoplay controls muted loop playsinline height="100%">
								<source src="./static/videos/test_video2.mp4" type="video/mp4" />
							</video>
						</div>
					</div>
				</div>
			</div>
		</section>

		<section class="section">
			<div class="container is-max-desktop">
				<!-- Abstract. -->
				<div class="columns is-centered has-text-centered">
					<div class="column is-four-fifths">
						<h2 class="title is-3">Abstract</h2>
						<div class="content has-text-justified">
							<p>
								Generating realistic 3D dance based on music is a unique and challenging task because real dance is a free
								and creative form of artistic expression. Human dance styles are diverse and ever-changing. Existing methods
								fail to perform well on out-of-domain music inputs or to generate movements of new dance styles.
								Accordingly, in this paper, we propose the Dance Latent Diffusion Model (DanceLDM), an advanced editable
								dance generation method for creating realistic and diverse 3D dance movements, while providing a text prompt
								interface for dance movement editing. Inspired by the Latent Diffusion Model, we combine a VAE-based motion
								autoencoder with a Transformer-based dance diffusion model, where the motion autoencoder extracts human
								motion features and learns a low-dimensional latent space, and the dance diffusion model subsequently learns
								dance motion generation in this latent space. To generate new and richly diverse dance movements, DanceLDM
								learns both Text-to-Motion and Music-to-Dance tasks, to enable effective dance editing guided by text
								prompts after generating dance from music. To further improve the rhythm of the generated dance, we
								incorporate beat signals into the model to generate more rhythmic dance movements. Experimental results
								demonstrate that, compared to existing methods, our proposed model achieves state-of-the-art performance on
								the Music-to-Dance generation benchmark and achieves comparable performance on the Text-to-Motion generation
								task.
							</p>
						</div>
					</div>
				</div>
				<!--/ Abstract. -->
			</div>
		</section>

		<section class="section">
			<!-- Paper video. -->
			<div class="columns is-centered has-text-centered">
				<div class="column is-four-fifths">
					<h2 class="title is-3">Framework</h2>
					<div class="publication-video">
						<img src="./static/images/method overview.png" alt="Teaser Image" style="width: 80%" />
					</div>
				</div>
			</div>
			<!--/ Paper video. -->
		</section>
		<!-- todo:  ------------------------------------------------------------------------------------------------------------------------------------------------- -->
		<section class="bg-bg px-2 py-2 lg:!px-4 lg:!py-8 text-white relative items-center justify-center h-fit">
			<div class="flex flex-col w-full h-full bg-nav rounded-md p-4 lg:!p-8">
				<nav class="flex px-2 pb-2">
					<div class="flex lg:pb-2 lg:px-8 items-center gap-2">
						<!-- <img src="./static/images/miis_lab_logo.png" class="w-14" alt="logo" /> -->
						<!-- <div class="border border-gray-400 h-8 mx-2"></div> -->
						<div class="title text-2xl lg:text-3xl text-gray-200 pb-1">DanceLDM</div>
					</div>
				</nav>

				<form id="promptForm" enctype="multipart/form-data">
					<div class="py-10 px-4 bg-container grid grid-cols-1 lg:grid-cols-2 rounded-md">
						<div class="container-left lg:px-6 flex flex-col">
							<div class="upload">
								<div class="flex h-fit mb-8 items-center text-xl font-bold">
									<div class="w-1 h-7 me-2 rounded-md bg-gradient-to-b from-[#6887BF] to-[#945F9F]"></div>
									Upload Music
								</div>
								<div class="flex gap-10">
									<div class="">
										<label for="file" class="flex gap-2 items-center">
											<div
												class="btn-upload flex px-5 py-2 gap-3 cursor-pointer hover:bg-violet-500/90 bg-btn rounded-sm items-center"
											>
												<i><img src="./static/images/upload.png" alt="upload icon" class="w-5" /> </i>
												<!-- <i class="fas fa-upload"></i> -->
												Upload Music
												<input id="file" type="file" accept=".wav" class="hidden" />
											</div>
											<div class="filename-text"></div>
										</label>
									</div>
								</div>
							</div>
							<div class="video-container gap-2 flex flex-col mt-8 p-4 bg-video-container rounded-md">
								<div class="flex justify-between items-end">
									<div class="video-title text-lg font-semibold items-center">Dance Video</div>
									<div class="video-name text-sm text-gray-400"></div>
								</div>
								<div class="">
									<!-- tab component start -->
									<div class="">
										<div x-data="{ openTab: 2 }">
											<div>
												<div
													x-show="openTab === 1"
													class="bg-video rounded-md items-center justify-center flex aspect-video"
												>
													<div class="loading-skeleton modal-body flex flex-col items-center gap-4 hidden">
														<div class="animate-pulse skeleton-progress-label text-2xl mt-4">Generating...</div>
														<div class="progress-container w-screen flex items-center justify-center">
															<div class="w-[70%] lg:w-96 bg-gray-200 rounded-full h-4 mb-4 bg-gray-500">
																<div
																	class="skeleton-progress h-4 rounded-full bg-gray-100"
																	style="width: 0%"
																></div>
															</div>
														</div>
													</div>
													<video src="" class="skeleton-video h-full hidden" controls></video>
												</div>

												<div
													x-show="openTab === 2"
													class="bg-video rounded-md items-center justify-center flex aspect-video"
												>
													<div class="loading-avatar modal-body flex flex-col items-center gap-4 hidden">
														<div class="animate-pulse avatar-progress-label text-2xl mt-4">Generating...</div>
														<div class="progress-container w-screen flex items-center justify-center">
															<div class="w-[70%] lg:w-96 bg-gray-200 rounded-full h-4 mb-4 bg-gray-500">
																<div
																	class="avatar-progress h-4 rounded-full bg-gray-100"
																	style="width: 0%"
																></div>
															</div>
														</div>
													</div>
													<video src="" class="avatar-video h-full hidden" controls></video>
												</div>
												<div class="mode-switch-btn-container flex justify-end items-center">
													<div class="mode-switch-btn flex flex-row mt-2 hidden">
														<div class="bg-gray-600 rounded-l-2xl">
															<div
																x-on:click="openTab = 1"
																:class="{ '!bg-btn !text-white !cursor-default': openTab === 1 }"
																class="bg-gray-600 py-2 px-4 text-gray-400 hover:text-gray-300 cursor-pointer rounded-2xl focus:outline-none focus:shadow-outline-blue transition-all duration-300"
															>
																Skeleton
															</div>
														</div>

														<div class="bg-gray-600 rounded-r-2xl">
															<div
																x-on:click="openTab = 2"
																:class="{ '!bg-btn !text-white !cursor-default': openTab === 2 }"
																class="bg-gray-600 py-2 px-4 text-gray-400 hover:text-gray-300 cursor-pointer rounded-2xl focus:outline-none focus:shadow-outline-blue transition-all duration-300"
															>
																Avatar
															</div>
														</div>
													</div>
													<div class="high-progress"></div>
													<div class="current-quality text-gray-400 text-sm"></div>
												</div>
											</div>
										</div>
									</div>
									<!-- tab component end -->
								</div>
								<!-- </div> -->
							</div>
						</div>
						<div class="container-right mt-8 lg:mt-0 lg:px-6 flex flex-col">
							<div class="edit w-full">
								<div class="flex h-fit mb-8 items-center text-xl font-bold">
									<div class="w-1 h-7 me-2 rounded-md bg-gradient-to-b from-[#6887BF] to-[#945F9F]"></div>
									Settings
									<!-- Edit DanceSetting -->
								</div>
								<div class="setting mb-5">
									<div class="mb-2">Quality</div>
									<div class="quality-selector bg-gray-600 inline-flex rounded-2xl">
										<div
											class="quality-high bg-[#4b83cf] py-2 px-4 text-center text-white cursor-default rounded-2xl focus:outline-none focus:shadow-outline-blue transition-all duration-300"
										>
											High quality (Slow)
										</div>
										<div
											class="quality-low bg-gray-600 py-2 px-4 text-center text-gray-400 hover:text-gray-300 cursor-pointer rounded-2xl focus:outline-none focus:shadow-outline-blue transition-all duration-300"
										>
											Low quality (Fast)
										</div>
									</div>
								</div>

								<div class="setting mb-5">
									<div class="description mb-2">Edit times Setting</div>
									<div class="slider flex items-center gap-2">
										<div class="slider-track-container">
											<div class="slider-track">
												<div id="startHandle" class="absolute -translate-x-1/2 slider-handle opacity-0"></div>
												<div id="endHandle" class="absolute -translate-x-1/2 slider-handle opacity-0"></div>
											</div>
										</div>
										<div class="slider-label text-nowrap text-sm"></div>
									</div>
								</div>

								<div class="flex gap-4 mb-5">
									<div class="setting flex-1">
										<label class="description">
											Start Time
											<div class="time-input mt-2 flex gap-1">
												<div class="flex-1 flex gap-1">
													<input
														min="0"
														type="number"
														value="0"
														id="startTime"
														step="0.001"
														disabled
														class="number-input bg-gray-700 p-2 text-slate-200 w-full"
													/>
													<div class="flex flex-col gap-1">
														<div class="increase-startTime-btn arrow select-none flex-1 bg-gray-700 px-1">
															<i class="fas fa-chevron-up"></i>
														</div>
														<div class="decrease-startTime-btn arrow select-none flex-1 bg-gray-700 px-1">
															<i class="fas fa-chevron-down"></i>
														</div>
													</div>
												</div>
											</div>
										</label>
									</div>
									<!--  -->
									<div class="setting flex-1">
										<label class="description">
											End Time
											<div class="time-input mt-2 flex gap-1">
												<div class="flex-1 flex gap-1">
													<input
														min="0"
														type="number"
														value="0"
														id="endTime"
														step="0.001"
														disabled
														class="number-input bg-gray-700 p-2 text-slate-200 w-full"
													/>
													<div class="flex flex-col gap-1">
														<div class="increase-endTime-btn arrow select-none flex-1 bg-gray-700 px-1">
															<i class="fas fa-chevron-up"></i>
														</div>
														<div class="decrease-endTime-btn arrow select-none flex-1 bg-gray-700 px-1">
															<i class="fas fa-chevron-down"></i>
														</div>
													</div>
												</div>
											</div>
										</label>
									</div>
								</div>

								<div class="setting mb-5">
									<label for="action-description" class="description"
										>Action Description
										<div class="time-input flex mt-2">
											<input
												id="action-description"
												type="text"
												placeholder="Please enter action description"
												class="description-input flex-1 bg-gray-700 p-2 text-slate-200 active:ring-0"
												disabled
											/></div
									></label>
								</div>
								<div class="setting-submit flex">
									<input
										value="Generate"
										id="submit"
										type="submit"
										class="submit-btn py-1 px-14 cursor-pointer hover:bg-violet-500/90 bg-btn rounded-sm items-center"
									/>
								</div>
							</div>
							<div class="history mt-10 w-full">
								<div class="flex h-fit mb-8 items-center text-xl font-bold">
									<div class="w-1 h-7 me-2 rounded-md bg-gradient-to-b from-[#6887BF] to-[#945F9F]"></div>
									History
								</div>
								<div id="historyContainer" class="history-container flex flex-wrap gap-4 pb-4"></div>
							</div>
						</div>
					</div>
				</form>
			</div>
			<div class="loading-skeleton absolute flex justify-center items-center inset-0 bg-gray-700/90 hidden"></div>
		</section>
		<div class="alert-container fixed top-10 left-1/2 -translate-x-1/2 -z-1 flex flex-col items-center gap-4"></div>
		<footer class="footer">
			<div class="container">
				<div class="content has-text-centered">
					<a class="icon-link" href="./static/videos/nerfies_paper.pdf">
						<i class="fas fa-file-pdf"></i>
					</a>
					<a class="icon-link" href="https://github.com/keunhong" class="external-link" disabled>
						<i class="fab fa-github"></i>
					</a>
				</div>
				<div class="columns is-centered">
					<div class="column is-8">
						<div class="content">
							<p>
								This website is licensed under a
								<a class="underline" rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"
									>Creative Commons Attribution-ShareAlike 4.0 International License</a
								>.
							</p>
							<p>
								<a class="underline" href="https://github.com/nerfies/nerfies.github.io"
									>The source code of this website template.</a
								>
							</p>
						</div>
					</div>
				</div>
			</div>
		</footer>

		<script src="https://cdn.jsdelivr.net/npm/alpinejs@2.8.2/dist/alpine.min.js" defer></script>
		<script>
			const alertContainer = document.querySelector('.alert-container');
			const waitForTimeout = (millisecond) => new Promise((resolve) => setTimeout(resolve, millisecond));
			const createErrorElement = (title, message) => {
				const alertElement = document.createElement('div');
				alertElement.classList.add(
					'alert',
					'z-10',
					'transition-opacity',
					'duration-1000',
					'opacity-0',
					'bg-red-100',
					'border-t-4',
					'border-red-500',
					'rounded-b',
					'text-red-900',
					'px-4',
					'py-3',
					'shadow-lg'
				);
				const innerHTML = `
				<div class="flex">
					<div class="py-1">
						<svg class="fill-current h-6 w-6 text-red-500 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
							<path
								d="M2.93 17.07A10 10 0 1 1 17.07 2.93 10 10 0 0 1 2.93 17.07zm12.73-1.41A8 8 0 1 0 4.34 4.34a8 8 0 0 0 11.32 11.32zM9 11V9h2v6H9v-4zm0-6h2v2H9V5z"
							/>
						</svg>
					</div>
					<div>
						<p class="font-bold">${title}</p>
						<p class="text-sm">${message}</p>
					</div>
				</div>`;
				alertElement.innerHTML = innerHTML;
				return alertElement;
			};
			const showError = async (title, message) => {
				const alertElement = createErrorElement(title, message);
				alertContainer.appendChild(alertElement);
				alertElement.classList.remove('opacity-0');
				await waitForTimeout(1000 + 3000);
				alertElement.classList.add('opacity-0');
				await waitForTimeout(1000);
				alertContainer.removeChild(alertElement);
			};
		</script>

		<!-- info: State Manager   -->
		<script>
			function createState(initialState) {
				let state = initialState;
				const listeners = [];
				const getState = () => state;
				const setState = (updater) => {
					if (typeof updater === 'function') state = updater(state);
					else state = updater;

					listeners.forEach((listener) => listener(state));
				};
				const subscribe = (listener) => {
					listeners.push(listener);
					return () => {
						const index = listeners.indexOf(listener);
						if (index > -1) listeners.splice(index, 1);
					};
				};
				return [getState, setState, subscribe];
			}
		</script>

		<!-- API test -->

		<script>
			const switchEnable = false;
			// const switchEnable = true;
			// const testBtn = document.querySelector('.testBtn');
			// testBtn.addEventListener('click', () => {
			// 	showError('Warning', 'test error');
			// });
			if (switchEnable) {
				const switchBtn = document.querySelector('.mode-switch-btn');
				const switchBtnContainer = document.querySelector('.mode-switch-btn-container');
				switchBtn.classList.remove('hidden');
				switchBtnContainer.classList.remove('justify-end');
				switchBtnContainer.classList.add('justify-between');
			}

			const promptForm = document.getElementById('promptForm');
			const fileUploadInput = document.querySelector('#file');
			const filenameText = document.querySelector('.filename-text');

			const danceVideoName = document.querySelector('.video-name');
			// const skeletonVideo = document.querySelector('.skeleton-video');
			const avatarVideo = document.querySelector('.avatar-video');
			const loadingSkeletonModal = document.querySelector('.loading-skeleton');
			// const skeletonProgressBar = document.querySelector('.skeleton-progress');
			// const skeletonProgressLabel = document.querySelector('.skeleton-progress-label');
			const loadingAvatarModal = document.querySelector('.loading-avatar');
			const avatarProgressBar = document.querySelector('.avatar-progress');
			const avatarProgressLabel = document.querySelector('.avatar-progress-label');

			const qualitySelector = document.querySelector('.quality-selector');
			const highQualityLabel = document.querySelector('.quality-high');
			const lowQualityLabel = document.querySelector('.quality-low');

			const sliderLabel = document.querySelector('.slider-label');
			const startTimeInput = document.querySelector('#startTime');
			const endTimeInput = document.querySelector('#endTime');
			const sliderTrack = document.querySelector('.slider-track');
			const startHandle = document.querySelector('#startHandle');
			const endHandle = document.querySelector('#endHandle');
			const increaseStartTimeBtn = document.querySelector('.increase-startTime-btn'); // increase-startTime-btn
			const decreaseStartTimeBtn = document.querySelector('.decrease-startTime-btn'); // decrease-startTime-btn
			const increaseEndTimeBtn = document.querySelector('.increase-endTime-btn'); // increase-endTime-btn
			const decreaseEndTimeBtn = document.querySelector('.decrease-endTime-btn'); // decrease-endTime-btn

			const descriptionInput = document.querySelector('.description-input');
			const historyContainer = document.querySelector('.history-container');

			const [timeState, setTimeState, timeSubscribe] = createState(null);
			const [historyState, setHistoryState, historyStateSubscribe] = createState([]);
			const emptyEditSettings = { file: null, settings: null, id: null };
			const [editState, setEditState, editStateSubscribe] = createState(emptyEditSettings);
			const step = 0.01;
			let highQuality = true;
			toggleQuality();

			const timeSettingBtnList = [
				{
					element: increaseStartTimeBtn,
					handler: () => {
						updateEditSettings({ startTime: editState().settings.startTime + step });
					},
				},
				{
					element: decreaseStartTimeBtn,
					handler: () => {
						updateEditSettings({ startTime: editState().settings.startTime - step });
					},
				},
				{
					element: increaseEndTimeBtn,
					handler: () => {
						updateEditSettings({ endTime: editState().settings.endTime + step });
					},
				},
				{
					element: decreaseEndTimeBtn,
					handler: () => {
						updateEditSettings({ endTime: editState().settings.endTime - step });
					},
				},
			];
			const timeSettingInputList = [
				{
					element: startTimeInput,
					handler: (event) => {
						updateEditSettings({ startTime: parseFloat(event.target.value) });
					},
				},
				{
					element: endTimeInput,
					handler: (event) => {
						updateEditSettings({ endTime: parseFloat(event.target.value) });
					},
				},
				{
					element: descriptionInput,
					handler: (event) => {
						updateEditSettings({ description: event.target.value });
					},
				},
			];

			let file;
			// let id = null;

			const enableEditControls = () => {
				const { settings } = editState();

				startTimeInput.setAttribute('max', settings.duration);
				endTimeInput.setAttribute('max', settings.duration);
				startTimeInput.removeAttribute('disabled');
				endTimeInput.removeAttribute('disabled');
				descriptionInput.removeAttribute('disabled');
				dragHandle(startHandle, true);
				dragHandle(endHandle, false);
				timeSettingBtnList.forEach(({ element, handler }) => {
					element.addEventListener('click', handler);
					element.classList.add('cursor-pointer');
				});
				timeSettingInputList.forEach(({ element, handler }) => {
					element.addEventListener('change', handler);
				});
			};
			const disabledEditControls = () => {
				startTimeInput.setAttribute('disabled', true);
				endTimeInput.setAttribute('disabled', true);
				descriptionInput.setAttribute('disabled', true);
				descriptionInput.value = '';
				disabledDragHandle(startHandle);
				disabledDragHandle(endHandle);
				timeSettingBtnList.forEach(({ element, handler }) => {
					element.removeEventListener('click', handler);
					element.classList.remove('cursor-pointer');
				});
				timeSettingInputList.forEach(({ element, handler }) => {
					element.removeEventListener('change', handler);
				});
			};
			const updateEditSettings = (newSettings) => {
				const { settings } = editState();
				if (newSettings.description)
					setEditState((state) => ({ ...state, settings: { ...settings, description: newSettings.description } }));
				else if (settings) {
					if (newSettings.startTime !== null && newSettings.startTime <= settings.endTime) {
						if (newSettings.startTime < 0) setEditState((state) => ({ ...state, settings: { ...settings, startTime: 0 } }));
						else setEditState((state) => ({ ...state, settings: { ...settings, startTime: newSettings.startTime } }));
					} else if (newSettings.endTime !== null && newSettings.endTime >= settings.startTime) {
						if (newSettings.endTime > settings.duration)
							setEditState((state) => ({ ...state, settings: { ...settings, endTime: settings.duration } }));
						else setEditState((state) => ({ ...state, settings: { ...settings, endTime: newSettings.endTime } }));
					} else setEditState((pre) => pre);
				}
			};

			const dragHandle = (handle, isStart) => {
				const { settings } = editState();
				handle.classList.remove('opacity-0');
				handle.classList.add('cursor-pointer');

				function updatePosition(position) {
					const rect = sliderTrack.getBoundingClientRect();
					let rate = (position - rect.left) / rect.width;
					if (rate < 0) rate = 0;
					if (rate > 1) rate = 1;

					if (isStart) updateEditSettings({ startTime: rate * settings.duration });
					else updateEditSettings({ endTime: rate * settings.duration });
				}
				handle.onmousedown = function (event) {
					event.preventDefault();
					document.onmousemove = function (event) {
						updatePosition(event.clientX);
					};

					document.onmouseup = function () {
						document.onmousemove = null;
						document.onmouseup = null;
					};
				};
				handle.ontouchstart = function (event) {
					event.preventDefault();
					document.ontouchmove = function (event) {
						updatePosition(event.touches[0].clientX);
					};
					document.ontouchend = function () {
						document.ontouchmove = null;
						document.ontouchend = null;
					};
				};
			};

			const disabledDragHandle = (handle) => {
				handle.classList.remove('cursor-pointer');
				handle.classList.add('opacity-0');

				handle.onmousedown = null;
				handle.onmouseup = null;
				handle.onmousemove = null;
				handle.ontouchstart = null;
				handle.ontouchmove = null;
				handle.ontouchend = null;
			};

			fileUploadInput.addEventListener('change', (e) => {
				console.log(' [debug] """"""value"""""": ');
				avatarVideo.classList.add('hidden');
				disabledEditControls();
				file = e.target.files[0];
				const audio = new Audio(URL.createObjectURL(file));

				audio.addEventListener('loadedmetadata', () => {
					const settings = {
						duration: audio.duration.toFixed(3),
						startTime: 0,
						endTime: audio.duration.toFixed(3),
						description: '',
					};
					const editStateT = {
						file: file,
						settings,
						id: null,
					};
					setEditState(editStateT);
					startTimeInput.setAttribute('max', settings.duration);
					endTimeInput.setAttribute('max', settings.duration);
					sliderLabel.innerText = `${settings.duration} sec`;
					// setTimeState(settings);
				});
			});

			const updateUI = ({ file, id, settings: { startTime, endTime, duration, description, quality } }) => {
				if (id == null) disabledEditControls();
				else enableEditControls();
				if (quality) {
					if ((highQuality && quality === 'low') || (!highQuality && quality === 'high')) toggleQuality();
				}

				if (file) {
					const { name } = file;
					filenameText.innerText = name;
				} else filenameText.innerText = name;

				startTimeInput.value = parseFloat(startTime).toFixed(3);
				avatarVideo.currentTime = parseFloat(startTime).toFixed(3);
				endTimeInput.value = parseFloat(endTime).toFixed(3);
				descriptionInput.value = description;

				const startPercent = (startTime / duration) * 100;
				const endPercent = (endTime / duration) * 100;

				const bgc = '#ddd';
				const color = '#4b83cf';
				// const color = '#0ea5e9';

				sliderTrack.style.background = `linear-gradient(to right, ${bgc} ${startPercent}%, ${color} ${startPercent}%, ${color} ${endPercent}%, ${bgc} ${endPercent}%)`;
				startHandle.style.left = startPercent + '%';
				endHandle.style.left = endPercent + '%';
				activateIcon(id);
			};
			const activateIcon = (id) => {
				const historyIndex = historyState().findIndex((history) => history.id === id);
				if (historyIndex === -1) return;
				historyList = Array.from(historyContainer.children);
				historyList.forEach((historyItem) => {
					const historyIcon = historyItem.children[1]; // 获取第二个子元素
					if (historyIcon) {
						historyIcon.classList.remove('!bg-violet-500/90'); // 添加 'active' class
					}
				});
				historyList[historyIndex].children[1].classList.add('!bg-violet-500/90');
			};
			const updateHistoryUI = (state) => {
				localStorage.setItem('historyState', JSON.stringify(state));
				historyContainer.innerHTML = '';
				state.forEach(({ id, skeleton_url, avatar_url, name, settings, rendering }, index) => {
					const videoHistory = document.createElement('div');
					videoHistory.className = 'history-item w-14 relative';
					const historyDeleteBtn = document.createElement('div');
					historyDeleteBtn.className =
						'flex items-center text-xs justify-center bg-gray-400/90 w-4 h-4 text-white rounded-full absolute -top-1 -right-1 cursor-pointer hover:bg-red-500 transition-opacity duration-300 delay-5000';
					historyDeleteBtn.innerHTML = `x`;
					const historyBtn = document.createElement('div');
					historyBtn.className = 'h-14 flex justify-center items-center bg-btn cursor-pointer hover:bg-violet-500/90 rounded-md';
					historyBtn.innerHTML = `<i><img src="./static/images/folder.png" alt="video icon" class="w-8" /></i>`;
					const historyLabel = document.createElement('div');
					historyLabel.className = 'history-item-name mt-2 text-xs text-center w-full break-words';
					historyLabel.innerText = name;
					const historyBtnHandler = () => {
						// document.onm
						// if (skeleton_url !== null) {
						// 	loadingSkeletonModal.classList.add('hidden');
						// 	skeletonVideo.classList.remove('hidden');
						// } else loadingAvatarModal.classList.remove('hidden');
						// if (skeleton_url !== skeletonVideo.src) skeletonVideo.setAttribute('src', skeleton_url);
						if (avatar_url !== null) {
							loadingAvatarModal.classList.add('hidden');
							avatarVideo.classList.remove('hidden');
						} else loadingSkeletonModal.classList.remove('hidden');
						if (rendering) {
							loadingAvatarModal.classList.remove('hidden');
							avatarVideo.classList.add('hidden');
						}
						if (avatar_url !== avatarVideo.src) avatarVideo.setAttribute('src', avatar_url);

						danceVideoName.innerText = name;
						setEditState({ file: null, settings, id });
					};
					historyBtn.addEventListener('click', historyBtnHandler);
					historyDeleteBtn.addEventListener('click', () => {
						event.stopPropagation();
						deleteHistory(id);
					});
					videoHistory.appendChild(historyDeleteBtn);
					videoHistory.appendChild(historyBtn);
					videoHistory.appendChild(historyLabel);
					historyContainer.appendChild(videoHistory);
				});
			};
			function deleteHistory(id) {
				const newHistory = historyState().filter((history) => history.id !== id);
				setHistoryState(newHistory);
			}

			editStateSubscribe(updateUI);
			historyStateSubscribe(updateHistoryUI);

			async function checkRerender(preId) {
				const historyIndex = historyState().findIndex((history) => history.id === preId);
				const history = historyState()[historyIndex];
				if (
					history?.settings.quality !== 'low' ||
					JSON.stringify({ ...history.settings, quality: 'high' }) !==
						JSON.stringify({ ...editState().settings, quality: highQuality ? 'high' : 'low' })
				) {
					console.log(' [debug] No rerender ');
					return false;
				}

				const formData = new FormData();
				formData.append('preId', preId);
				formData.append('sid', sid);
				try {
					progressUpdate(0, 'avatar');
					loadingAvatarModal.classList.remove('hidden');
					avatarVideo.classList.add('hidden');
					const newHistory = JSON.parse(JSON.stringify(historyState()));
					newHistory[historyIndex] = {
						...newHistory[historyIndex],
						settings: { ...newHistory[historyIndex].settings, quality: 'high' },
						rendering: true,
					};
					setHistoryState(newHistory);
					activateIcon(preId);

					const responseData = await rerenderById(formData);
					const { avatar_url, id } = responseData;
					newHistory[historyIndex] = {
						...newHistory[historyIndex],
						settings: { ...newHistory[historyIndex].settings, quality: 'high' },
						avatar_url: host + avatar_url,
						rendering: false,
					};
					setHistoryState(newHistory);
					activateIcon(preId);
					avatarVideo.setAttribute('src', host + avatar_url);
					loadingAvatarModal.classList.add('hidden');
					avatarVideo.classList.remove('hidden');
				} catch (error) {
					console.error(' [debug] error: ', error);
					showError('Error', 'Failed to connect to server.');
				}
				console.log(' [debug] high!!!!!: ');
				return true;
			}

			promptForm.addEventListener('submit', async (event) => {
				event.preventDefault();
				console.log(' [debug] submit ');
				if (editState().id && (await checkRerender(editState().id))) return;
				console.log(' [debug] generate! ');

				if (editState().file == null && (editState().settings == null || editState().id == null)) {
					showError('Warning', 'Please select a music file or choose a record from history.');
					return;
				}

				// skeletonVideo.classList.add('hidden');
				avatarVideo.classList.add('hidden');
				loadingSkeletonModal.classList.remove('hidden');
				loadingAvatarModal.classList.remove('hidden');

				const description = descriptionInput.value;
				const formData = new FormData();
				const { file, settings, id } = editState();
				const quality = highQuality ? 'high' : 'low';
				const newSettings = { ...settings, quality };
				const name = new Date().toLocaleTimeString('en-US');
				formData.append('preId', id);
				formData.append('file', file);
				formData.append('sid', sid);
				formData.append('name', name);
				formData.append('settings', JSON.stringify(newSettings));
				try {
					progressUpdate(0, 'skeleton');
					progressUpdate(0, 'avatar');
					const fake = false;
					let postMusicToServer;
					if (fake) postMusicToServer = fakeFetch;
					else postMusicToServer = generateBySettings;

					danceVideoName.innerText = name;

					const responseData = await postMusicToServer(formData);
					if (responseData?.success) {
						console.log(' [debug] comein?: ');
						const { skeleton_url, avatar_url, id } = responseData;

						// handle History
						deleteHistory(id);
						const history = {
							id,
							skeleton_url: host + skeleton_url,
							avatar_url: host + avatar_url,
							name,
							settings: newSettings,
							rendering: false,
						};
						setHistoryState((pre) => [...pre, history]);
						activateIcon(id);
						if ((highQuality && quality === 'low') || (!highQuality && quality === 'high')) toggleQuality();

						fileUploadInput.value = '';
					} else {
						console.log(' [debug] come out?: ');
						setEditState(emptyEditSettings);
						avatarVideo.classList.add('hidden');
					}
				} catch (error) {
					console.log(error);
					showError('Error', 'Failed to connect to server.');
				}
				console.log(' [debug] reset progress: ');

				loadingSkeletonModal.classList.add('hidden');
				loadingAvatarModal.classList.add('hidden');
			});
			function toggleQuality() {
				activateLabel = lowQualityLabel;
				nonActivateLabel = highQualityLabel;
				if (highQuality) {
					activateLabel = highQualityLabel;
					nonActivateLabel = lowQualityLabel;
				}
				activateLabel.classList.remove('bg-[#4b83cf]', 'text-white', 'cursor-default');
				activateLabel.classList.add('bg-gray-600', 'text-gray-400', 'cursor-pointer', 'hover:text-gray-300');

				nonActivateLabel.classList.add('bg-[#4b83cf]', 'text-white', 'cursor-default');
				nonActivateLabel.classList.remove('bg-gray-600', 'text-gray-400', 'cursor-pointer', 'hover:text-gray-300');

				highQuality = !highQuality;
			}
			qualitySelector.addEventListener('click', toggleQuality);
			// load history
			setHistoryState(JSON.parse(localStorage.getItem('historyState')) || []);
		</script>

		<!-- backend service -->
		<script>
			// const HOST = 'https://native-oarfish-highly.ngrok-free.app';
			// const LOCALHOST = 'http://127.0.0.1:8443';
			const LOCALHOST = 'http://127.0.0.1:8443';
			const HOST = 'https://miislab.pagekite.me/';
			const host =
				window.location.host === 'gaozhengting3.github.io' || window.location.host === 'miislab.github.io' ? HOST : LOCALHOST;
			// const host = HOST;
			console.log(' [debug] host: ', host);
			let sid;

			// Socket handler
			const socket = io(host, { transports: ['websocket', 'polling'] });
			socket.on('join', (data) => {
				console.log(' [debug] connect to socket server: ', data.sid);
				sid = data.sid;
			});

			socket.on('video_create', ({ id, name, settings }) => {
				console.log(' [debug] "create!!!!!!": ', 'create!!!!!!');
				settings = JSON.parse(settings);
				setEditState((pre) => ({ id, file: null, settings }));
				const history = { id, skeleton_url: null, avatar_url: null, name, settings, rendering: true };
				setHistoryState((pre) => [...pre, history]);
				activateIcon(id);
			});

			socket.on('progress_update', ({ id, progress, type }) => {
				console.log(' [debug] progress_update: ', id, progress, type);
				if (id == editState().id) progressUpdate(progress, type);
			});

			socket.on('progress_done', ({ id, type, url }) => {
				video_url = host + url;
				// console.log(' [debug] progress_done: ', type, video_url);
				if (type == 'skeleton') {
					// if (video_url !== skeletonVideo.src) skeletonVideo.setAttribute('src', video_url);
					// skeletonVideo.classList.remove('hidden');
					// loadingSkeletonModal.classList.add('hidden');
				} else if (type == 'avatar') {
					if (video_url !== avatarVideo.src) avatarVideo.setAttribute('src', video_url);
					avatarVideo.classList.remove('hidden');
					loadingAvatarModal.classList.add('hidden');
				}
			});

			socket.on('connect_error', (err) => {
				console.error('Socket connection error:', err);
			});
			function progressUpdate(progress, type) {
				if (type == 'skeleton') {
					// skeletonProgressLabel.innerText = `Generating...\t${parseInt(progress * 100)}%`;
					// skeletonProgressBar.style.width = `${progress * 100}%`;
				} else if (type == 'avatar') {
					let adjustedProgress = parseInt(progress * 100);
					if (adjustedProgress < 10) adjustedProgress += 1;
					avatarProgressLabel.innerHTML = `Generating... ${adjustedProgress}%`;
					// avatarProgressLabel.innerHTML = `<div class="animate-pulse">Generating...\t${adjustedProgress}%</div>
					// 	<br>
					// 	<div>Generating<span class="after:content-['.'] after:animate-ellipsis"></span>\t${adjustedProgress}%</div>`;
					// avatarProgressLabel.innerHTML = ``;
					avatarProgressBar.style.width = `${progress * 100}%`;
				}
			}
			async function fakeFetch(request) {
				const timeout = 1500;
				const intervalMS = 100;
				let generateProgress = 0;
				const interval = setInterval(() => {
					generateProgress += intervalMS / timeout;
					progressUpdate(generateProgress);
				}, intervalMS);
				await waitForTimeout(timeout);
				clearInterval(interval);
				const responseData = { id: 1, success: true, message: 'done', video_url: './static/videos/test_video1.mp4' };
				return responseData;
			}

			async function generateBySettings(formData) {
				try {
					const response = await fetch(host + '/generate', { method: 'POST', body: formData });
					const responseData = await response.json();
					if (responseData?.success) return responseData;
					if (responseData?.id) {
						deleteHistory(responseData.id);
						showError('Error', responseData?.message);
						return responseData;
					}
				} catch (err) {}
			}
			async function rerenderById(formData) {
				const response = await fetch(host + '/rerender', { method: 'POST', body: formData });
				const responseData = await response.json();
				return responseData;
			}
		</script>
	</body>
</html>
